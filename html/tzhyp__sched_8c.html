<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>tzhyp_sched.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_6aeebb853ebd8c514e6186653c592c82.html">otzone</a></li><li class="navelem"><a class="el" href="dir_fb44076c8b62c63869cf8a830933e50d.html">src</a></li><li class="navelem"><a class="el" href="dir_5054d892aa124e015c653e8232659643.html">arch</a></li><li class="navelem"><a class="el" href="dir_a8ff73de53c273984b8a08f3bd00cae5.html">arm</a></li><li class="navelem"><a class="el" href="dir_0f6da8a9c5259cd162214505231682b4.html">armv7</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">tzhyp_sched.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="system__context_8h_source.html">system_context.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__debug_8h_source.html">sw_debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__timer_8h_source.html">sw_timer.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="tzhyp__global_8h_source.html">tzhyp_global.h</a>&gt;</code><br/>
</div>
<p><a href="tzhyp__sched_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a7fc2dc4ad4fef314bf988d672c64a65d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tzhyp__sched_8c.html#a7fc2dc4ad4fef314bf988d672c64a65d">tzhyp_schedule_guest</a> (void)</td></tr>
<tr class="memdesc:a7fc2dc4ad4fef314bf988d672c64a65d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hypervisor scheduler does the job of scheduling between multiple guest OS.  <a href="#a7fc2dc4ad4fef314bf988d672c64a65d"></a><br/></td></tr>
<tr class="separator:a7fc2dc4ad4fef314bf988d672c64a65d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4591534998b0845f3bd6f56f2851616b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tzhyp__sched_8c.html#a4591534998b0845f3bd6f56f2851616b">tzhyp_schedevent_init</a> (void)</td></tr>
<tr class="separator:a4591534998b0845f3bd6f56f2851616b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a4591534998b0845f3bd6f56f2851616b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int tzhyp_schedevent_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section return"><dt>Returns</dt><dd></dd></dl>

<p>Definition at line <a class="el" href="tzhyp__sched_8c_source.html#l00108">108</a> of file <a class="el" href="tzhyp__sched_8c_source.html">tzhyp_sched.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef SW_OTZHYP_DEBUG    </span></div>
<div class="line"><span class="preprocessor"></span>        <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;tzhyp_schedevent_init\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        tzhypsched_event = <a class="code" href="sw__timer_8h.html#a37105580638257400682808d9dd0d684" title="This function is called to create a new timer event. It allocates the memory for timer event struct...">timer_event_create</a>(&amp;tzhyp_schedevent_handler, </div>
<div class="line">                                              (<span class="keywordtype">void</span>*)<a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line">        <span class="keywordflow">if</span>(!tzhypsched_event){</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;xxx : Cannot register Handler\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Time duration = 40ms */</span></div>
<div class="line">        tzhypsched_time.<a class="code" href="uniontimeval__t.html#a8ad7ddf26aa2f31d18780864fbbae04c">tval</a>.<a class="code" href="uniontimeval__t.html#a85f38542a8fa84ce968e2297bf8f7487">nsec</a> = 40000000;</div>
<div class="line">        tzhypsched_time.<a class="code" href="uniontimeval__t.html#a8ad7ddf26aa2f31d18780864fbbae04c">tval</a>.<a class="code" href="uniontimeval__t.html#a9c6a9d36de22b39f398f77325ee07539">sec</a> = 0;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="sw__timer_8h.html#ae9578a02129a7b5c79e395fe76d4562c" title="It starts the timer event by calling the appropriate functions The time interval is written to the ha...">timer_event_start</a>(tzhypsched_event, &amp;tzhypsched_time);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a7fc2dc4ad4fef314bf988d672c64a65d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tzhyp_schedule_guest </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hypervisor scheduler does the job of scheduling between multiple guest OS. </p>
<p>CPU context switching to a new guest OS For every guest OS there is a cpu register context meant for NS world. Secure world is common across all guest OS. CPU register context involves both core registers and system registers(eg. cp15). a. The sytem register context of the 'current' guest OS(NS world) is saved and the same is restored with that of the 'next' guest OS to be scheduled. b. Saving and restoring of core registers(NS world) is handled by the monitor fiq handler entry and exit path. So we just need to adjust he context pointers so that the right core register context gets restored during exit from the exception.</p>

<p>Definition at line <a class="el" href="tzhyp__sched_8c_source.html#l00049">49</a> of file <a class="el" href="tzhyp__sched_8c_source.html">tzhyp_sched.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsystem__context.html">system_context</a> *boundary = &amp;<a class="code" href="tzhyp__global_8h.html#a510187ef2a59eece79ae2acabb444e85" title="Non secure task contexts.">ns_world</a>[0] + <a class="code" href="tzhyp__config_8h.html#ad2aff408ca4101ac34537fcfeb70dd9e">GUESTS_NO</a>;</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structsystem__context.html">system_context</a> *<a class="code" href="sw__buddy_8h.html#ad05441302211504d54462741b9a97b3a">current</a>, *next;</div>
<div class="line"><span class="preprocessor">#ifdef SCHEDULE_HIGH_PRIORITY_GUEST</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keyword">static</span> <a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> <a class="code" href="virtual__keyboard_8c.html#a16ff2d8e15ade4948398b0aeb80124a8">count</a> = 0, low_priority_guest_scheduled = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef SW_OTZHYP_DEBUG    </span></div>
<div class="line"><span class="preprocessor"></span>        <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;tzhyp_sched_guest\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        current = <a class="code" href="tzhyp__global_8h.html#a34c3cf9b08f0d34a32537d6bbc3665e8" title="Non secure and Secure context pointers.">ns_sys_current</a>;       </div>
<div class="line"><span class="preprocessor">#ifdef SCHEDULE_HIGH_PRIORITY_GUEST</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span>(current-&gt;<a class="code" href="structsystem__context.html#abaa5314fa254317d5d7352de34e76be7">guest_no</a> != HIGH_PRIORITY_GUEST)</div>
<div class="line">                low_priority_guest_scheduled = 1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(low_priority_guest_scheduled &amp;&amp; </div>
<div class="line">        is_guest_irq_active(current-&gt;<a class="code" href="structsystem__context.html#abaa5314fa254317d5d7352de34e76be7">guest_no</a>)) {</div>
<div class="line">        <span class="comment">/* Schedule the low priorty guest @ 800 milli seconds interval</span></div>
<div class="line"><span class="comment">            40ms * 20 = 800 milli seconds */</span></div>
<div class="line">        <span class="keywordflow">if</span>(count &lt; 20) {</div>
<div class="line">            count ++;</div>
<div class="line">            <span class="keywordflow">return</span> current-&gt;<a class="code" href="structsystem__context.html#abaa5314fa254317d5d7352de34e76be7">guest_no</a>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            count = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        next = <a class="code" href="tzhyp__global_8h.html#a34c3cf9b08f0d34a32537d6bbc3665e8" title="Non secure and Secure context pointers.">ns_sys_current</a> + 1;</div>
<div class="line">        <span class="keywordflow">if</span> (next &gt;= boundary) <span class="comment">/* reset to index 0 */</span></div>
<div class="line">                next = <a class="code" href="tzhyp__global_8h.html#a510187ef2a59eece79ae2acabb444e85" title="Non secure task contexts.">ns_world</a>;</div>
<div class="line"><span class="preprocessor">#ifdef SW_OTZHYP_DEBUG    </span></div>
<div class="line"><span class="preprocessor"></span>        <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;current = %x, next = %x\n&quot;</span>, current, next);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        <a class="code" href="tzhyp__global_8h.html#a34c3cf9b08f0d34a32537d6bbc3665e8" title="Non secure and Secure context pointers.">ns_sys_current</a> = next;  </div>
<div class="line">        <a class="code" href="system__context_8h.html#a899474d506a28251a7e14755af6e337c">tzhyp_sysregs_switch</a>(&amp;current-&gt;<a class="code" href="structsystem__context.html#a7c7c863469000c7b1777c62c4c14fe56">sysctxt_cp15</a>, &amp;next-&gt;<a class="code" href="structsystem__context.html#a7c7c863469000c7b1777c62c4c14fe56">sysctxt_cp15</a>);</div>
<div class="line">        <a class="code" href="tzhyp__global_8h.html#a5182162de4b2dca61076a52abdf56c32">tzhyp_device_switch</a>(current, next);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jan 3 2013 00:33:53 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
